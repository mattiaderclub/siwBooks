<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">

<head>
	<meta charset="UTF-8">
	<title th:text="${book.title}">Dettaglio Libro</title>
</head>

<body>

	<!-- Logo cliccabile per tornare alla home -->
	<div>
		<a href="/"><img src="/images/logo-siwBooks.png" alt="Home" width="150" /></a>
	</div>

	<h1 th:text="${book.title}">Titolo Libro</h1>

	<p><strong>Anno di pubblicazione:</strong> <span th:text="${book.annoPubblicazione}">2020</span></p>

	<div th:if="${book.imagePaths != null}">
		<p><strong>Immagini del libro:</strong></p>
		<div th:each="img : ${book.imagePaths}">
			<img th:src="@{${img}}" alt="Immagine Libro" width="200" />
		</div>
	</div>

	<p><strong>Autori:</strong></p>
	<ul>
		<li th:each="autore : ${book.autori}">
			<a th:href="@{/author/{id}(id=${autore.id})}" th:text="${autore.name + ' ' + autore.surname}">Autore</a>
		</li>
	</ul>

	<p><strong>Valutazione media:</strong>
		<span th:if="${averageRating != null}" th:text="${averageRating}">4.5</span>
		<span th:unless="${averageRating != null}">Nessuna valutazione</span>
	</p>

	<!-- ----------------------------------------- -->
	<!-- 1. Lista delle recensioni -->
	<!-- ----------------------------------------- -->
	<h2>Recensioni</h2>

	<div th:if="${book.recensioni != null and #lists.isEmpty(book.recensioni) == false}">
		<div th:each="review : ${book.recensioni}" style="border: 1px solid #ccc; padding: 1em; margin-bottom: 1em;">
			<h3 th:text="${review.title}">Titolo</h3>
			<p><strong>Voto:</strong> <span th:text="${review.rating}"></span>/5</p>
			<p th:text="${review.text}">Contenuto della recensione</p>
			<p><em>di <span th:text="${review.user.name + ' ' + review.user.surname}">Autore</span></em></p>

			<!-- Se utente loggato è l'autore -->
			<div th:if="${userDetails != null and credentials != null and review.user.id == credentials.user.id}">
				<a th:href="@{'/reviews/edit/' + ${review.id}}">✏️ Modifica</a>
				<form th:action="@{'/review/delete/' + ${review.id}}" method="post" style="display: inline;">
					<button type="submit">🗑️ Elimina</button>
				</form>
			</div>

			<!-- Se utente è admin -->
			<div th:if="${credentials != null and credentials.role == 'ADMIN'}">
				<form th:action="@{'/review/delete/' + ${review.id}}" method="post">
					<button type="submit">🗑️ Elimina (Admin)</button>
				</form>
			</div>
		</div>
	</div>

	<p th:if="${#lists.isEmpty(book.recensioni)}">Nessuna recensione per questo libro.</p>

	<!-- ----------------------------------------- -->
	<!-- 2. Azione utente: aggiungi o già recensito -->
	<!-- ----------------------------------------- -->

	<div th:if="${credentials != null and credentials.role == 'DEFAULT'}">
		<div th:if="${myReview == null}">
			<a th:href="@{'/reviews/new/' + ${book.id}}">📝 Scrivi una recensione</a>
		</div>
		<div th:if="${myReview != null}">
			<p>✅ Hai già recensito questo libro.</p>
		</div>
	</div>

</body>

</html>
