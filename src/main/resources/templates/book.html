<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">

<head>
	<meta charset="UTF-8">
	<title th:text="${book.title}">Dettaglio Libro</title>
</head>

<body>

	<!-- Logo cliccabile per tornare alla home -->
	<div>
		<a href="/"><img src="/images/logo-siwBooks.png" alt="Home" width="150" /></a>
	</div>

	<h1 th:text="${book.title}">Titolo Libro</h1>

	<p><strong>Anno di pubblicazione:</strong> <span th:text="${book.annoPubblicazione}">2020</span></p>

	<div th:if="${book.imagePaths != null}">
		<p><strong>Immagini del libro:</strong></p>
		<div th:each="img : ${book.imagePaths}">
			<img th:src="@{${img}}" alt="Immagine Libro" width="200" />
		</div>
	</div>

	<p><strong>Autori:</strong></p>
	<ul>
		<li th:each="autore : ${book.autori}">
			<a th:href="@{/author/{id}(id=${autore.id})}" th:text="${autore.name + ' ' + autore.surname}">Autore</a>
		</li>
	</ul>

	<p><strong>Valutazione media:</strong>
		<span th:if="${averageRating != null}" th:text="${averageRating}">4.5</span>
		<span th:unless="${averageRating != null}">Nessuna valutazione</span>
	</p>

	<!-- ----------------------------------------- -->
	<!-- 1. Lista delle recensioni -->
	<!-- ----------------------------------------- -->
	<h2>Recensioni</h2>

	<div th:if="${book.recensioni != null and #lists.isEmpty(book.recensioni) == false}">
		<div th:each="review : ${book.recensioni}" style="border: 1px solid #ccc; padding: 1em; margin-bottom: 1em;">
			<h3 th:text="${review.title}">Titolo</h3>
			<p>
				<strong>Voto:</strong> <span th:text="${review.rating}"></span>/5
			</p>
			<p th:text="${review.text}">Contenuto della recensione</p>
			<p><em>di <span th:text="${review.user.name + ' ' + review.user.surname}">Autore</span></em></p>

			<!-- Se utente loggato è l'autore, mostra bottoni modifica/elimina -->
			<div th:if="${userDetails != null and review.user.id == credentials.user.id}">
				<form th:action="@{'/book/' + ${book.id} + '/review/edit/' + ${review.id}}" method="post">
					<input type="text" name="title" th:value="${review.title}" placeholder="Titolo" required />
					<input type="number" name="rating" min="1" max="5" th:value="${review.rating}" required />

					<textarea name="text" required th:text="${review.text}"></textarea>
					<button type="submit">Salva modifiche</button>
				</form>
				<form th:action="@{'/review/delete/' + ${review.id}}" method="post" style="margin-top: 0.5em;">
					<button type="submit">Elimina</button>
				</form>
			</div>

			<!-- Se utente è admin -->
			<div th:if="${credentials != null and credentials.role == 'ADMIN'}">
				<form th:action="@{'/review/delete/' + ${review.id}}" method="post">
					<button type="submit">Elimina (Admin)</button>
				</form>
			</div>
		</div>
	</div>

	<p th:if="${#lists.isEmpty(book.recensioni)}">Nessuna recensione per questo libro.</p>


	<!-- ----------------------------------------- -->
	<!-- 2. Form per nuova recensione -->
	<!-- ----------------------------------------- -->
	<div th:if="${userDetails != null and myReview == null and credentials.role == 'DEFAULT'}">
		<h3>Scrivi una recensione</h3>

		<form th:action="@{'/book/' + ${book.id} + '/review'}" method="post" th:object="${reviewForm}">
			<label for="title">Titolo</label>
			<input type="text" th:field="*{title}" />
			<p th:if="${#fields.hasErrors('title')}" th:errors="*{title}">Il titolo della recensione è obbligatorio</p>

			<label for="rating">Voto (1-5)</label>
			<input type="number" min="1" max="5" th:field="*{rating}" />
			<p th:if="${#fields.hasErrors('rating')}" th:errors="*{rating}">Il voto è obbligatorio</p>

			<label for="text">Testo</label>
			<textarea th:field="*{text}"></textarea>
			<p th:if="${#fields.hasErrors('text')}" th:errors="*{text}">Il contenuto non può essere vuoto</p>


			<button type="submit">Invia recensione</button>
		</form>
	</div>

	<div th:if="${userDetails != null and myReview != null}">
		<p>Hai già recensito questo libro. Puoi modificarla o eliminarla qui sopra.</p>
	</div>

</body>

</html>